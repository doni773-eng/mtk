<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Absensi Siswa — Futuristic</title>
  <meta name="description" content="Aplikasi absensi offline-first yang mengirim ke Google Spreadsheet." />
  <style>
    /* ---------- Futuristic UI (minimal CSS, no external libs) ---------- */
    :root{
      --bg:#0b1020;
      --card:#0f1724;
      --muted:#94a3b8;
      --accent:#7c3aed; /* violet */
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --success:#06b6d4;
      --danger:#ef4444;
      --radius:14px;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#020617 0%, var(--bg) 60%);color:#e6eef8}
    .wrap{max-width:1100px;margin:32px auto;padding:20px;display:grid;grid-template-columns:380px 1fr;gap:20px}
    header{grid-column:1/-1;display:flex;align-items:center;gap:16px}
    .logo{
      width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#06b6d4);
      display:flex;align-items:center;justify-content:center;box-shadow:0 6px 30px rgba(124,58,237,0.18);
      font-weight:700;color:white;font-size:18px;
    }
    h1{margin:0;font-size:20px;letter-spacing:0.2px}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    .card{background:linear-gradient(180deg,var(--glass),var(--glass-2));border-radius:var(--radius);padding:16px;box-shadow:0 6px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .left .card + .card{margin-top:14px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    textarea, input[type="text"], select{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;outline:none;font-size:14px}
    textarea{min-height:120px;resize:vertical}
    .row{display:flex;gap:8px;align-items:center}
    .btn{
      display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:10px;border:0;cursor:pointer;font-weight:600;
      background:linear-gradient(90deg,var(--accent),#06b6d4);color:#fff;box-shadow:0 6px 20px rgba(7,12,34,0.6);
    }
    .btn.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px;color:var(--muted)}
    input[type=file]{color:var(--muted)}
    table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
    th,td{padding:8px;text-align:left;border-bottom:1px dashed rgba(255,255,255,0.03)}
    th{font-size:12px;color:var(--muted)}
    .status-dot{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:8px;vertical-align:middle}
    .status-hadir{background:#10b981}
    .status-izin{background:#f59e0b}
    .status-sakit{background:#60a5fa}
    .status-alpa{background:#ef4444}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .indicator{display:flex;gap:10px;align-items:center}
    .chip{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.02);font-size:13px}
    .log{height:110px;overflow:auto;background:rgba(0,0,0,0.25);padding:10px;border-radius:10px;font-family:monospace;font-size:12px}

    /* responsive */
    @media(max-width:980px){.wrap{grid-template-columns:1fr;padding:12px} .left{order:2} .right{order:1}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">AS</div>
      <div>
        <h1>Absensi Siswa — Futuristic</h1>
        <p class="lead">Offline-first • Bulk add • Auto-sync ke Google Spreadsheet saat online</p>
      </div>
    </header>

    <!-- LEFT: Controls -->
    <div class="left">
      <div class="card">
        <div class="topbar">
          <div class="muted">Tambah Siswa (bulk)</div>
          <div class="indicator">
            <div id="onlineChip" class="chip">—</div>
          </div>
        </div>

        <label for="bulkNames">Paste nama (satu per baris)</label>
        <textarea id="bulkNames" placeholder="Contoh: Budi Santoso&#10;Siti Aminah&#10;Rian Pratama"></textarea>

        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="importBtn" class="btn">Tambah</button>
          <button id="importCsvBtn" class="btn secondary">Import CSV</button>
          <input type="file" id="csvFile" accept=".csv" style="display:none" />
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(255,255,255,0.03)" />

        <label for="date">Pilih Tanggal (opsional)</label>
        <input type="date" id="date"/>

        <div style="display:flex;gap:8px;margin-top:10px">
          <button id="loadBtn" class="btn secondary">Muat Daftar</button>
          <button id="saveBtn" class="btn">Simpan (Local)</button>
          <button id="syncBtn" class="btn">Sync Now</button>
        </div>
      </div>

      <div class="card" style="margin-top:14px">
        <div class="muted">Log Aktivitas</div>
        <div id="log" class="log"></div>
      </div>
    </div>

    <!-- RIGHT: Table -->
    <div class="right">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div class="muted">Daftar Hadir</div>
          <div class="small">Status: <span id="onlineText">?</span></div>
        </div>

        <div id="tableWrap" style="margin-top:10px">
          <div class="muted">Muat siswa dari panel kiri atau import CSV.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
  /**************************************************************************
   * FUTURISTIC ABSENSI - Single-file app
   * - Ganti APPS_SCRIPT_URL dengan URL Web App Apps Script Anda
   * - Apps Script sebaiknya di-deploy dengan "Execute as: Me" & "Who has access: Anyone"
   **************************************************************************/
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz8bkHup-P53gtwzEzCTFexVfT60_SPOBpU9oOM1uVeIMz8aQ1o4GBubqPk3L985zIp/exec"; // <-- GANTI DI SINI

  const STATUSES = [
    {value:'Hadir', label:'Hadir', cls:'status-hadir'},
    {value:'Izin', label:'Izin', cls:'status-izin'},
    {value:'Sakit', label:'Sakit', cls:'status-sakit'},
    {value:'Alpa', label:'Alpa', cls:'status-alpa'}
  ];

  /* -------------------- Simple IndexedDB wrapper -------------------- */
  function openDB(){
    return new Promise((resolve,reject)=>{
      const req = indexedDB.open('absensi-db',1);
      req.onupgradeneeded = e=>{
        const db = e.target.result;
        if(!db.objectStoreNames.contains('students')) db.createObjectStore('students',{keyPath:'id'});
        if(!db.objectStoreNames.contains('attendances')) {
          const s = db.createObjectStore('attendances',{keyPath:'id'});
          s.createIndex('synced','synced',{unique:false});
          s.createIndex('date','date',{unique:false});
        }
      };
      req.onsuccess = e=>resolve(e.target.result);
      req.onerror = e=>reject(e.target.error);
    });
  }

  async function idbAdd(storeName, obj){
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction(storeName,'readwrite').objectStore(storeName);
      const r = tx.add(obj);
      r.onsuccess = ()=>res(r.result);
      r.onerror = ()=>rej(r.error);
    });
  }
  async function idbGetAll(storeName){
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction(storeName).objectStore(storeName);
      const r = tx.getAll();
      r.onsuccess = ()=>res(r.result || []);
      r.onerror = ()=>rej(r.error);
    });
  }
  async function idbClear(storeName){
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction(storeName,'readwrite').objectStore(storeName);
      const r = tx.clear();
      r.onsuccess = ()=>res();
      r.onerror = ()=>rej(r.error);
    });
  }
  async function idbMarkSynced(ids){
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction('attendances','readwrite').objectStore('attendances');
      let left = ids.length;
      ids.forEach(id=>{
        const g = tx.get(id);
        g.onsuccess = ()=>{
          const obj = g.result;
          if(obj){ obj.synced = true; obj.syncedAt = new Date().toISOString(); tx.put(obj); }
          if(--left===0) res(true);
        };
        g.onerror = ()=>{ if(--left===0) res(true); };
      });
    });
  }

  /* -------------------- UI helpers -------------------- */
  const logEl = document.getElementById('log');
  function log(msg){
    const line = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logEl.textContent = line + "\n" + logEl.textContent;
  }
  function setOnlineStatus(){
    const online = navigator.onLine;
    document.getElementById('onlineText').textContent = online ? 'Online' : 'Offline';
    const chip = document.getElementById('onlineChip');
    chip.textContent = online ? 'Online' : 'Offl
